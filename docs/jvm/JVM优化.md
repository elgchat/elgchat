# Java虚拟机优化（Jvm优化）

Java 虚拟机的运行优化主要是内存分配和垃圾回收策略的优化:

* 内存直接影响服务的运行效率和吞吐量
* 垃圾回收机制会不同程度地导致程序运行中断(垃圾回收策略不同，垃圾回收次数和回收效率都是
    不同的)

## Jvm虚拟机内存相关参数



| 参数                 | 参数作用                                           | 优化建议                            |
| -------------------- | -------------------------------------------------- | ----------------------------------- |
| -server              | 启动Server                                         | 以服务端模式运行 服务端模式建议开启 |
| -Xms                 | 最小堆内存                                         | 建议与-Xmx设置相 同                 |
| -Xmx                 | 最大堆内存                                         | 建议设置为可用内存 的80%            |
| -XX:MetaspaceSize    | 元空间初始值                                       |                                     |
| -XX:MaxMetaspaceSize | 元空间最大内存                                     | 默认无限                            |
| -XX:NewRatio         | 年轻代和老年代大小比值，取值为整数，默 认为2       | 不需要修改                          |
| -XX:SurvivorRatio    | Eden区与Survivor区大小的比值，取值为整 数，默认为8 | 不需要修改                          |

### 参数调整示例

```
JAVA_OPTS="-server -Xms2048m -Xmx2048m -XX:MetaspaceSize=256m -
XX:MaxMetaspaceSize=512m"
```

### 调整后查看可使用**JDK**提供的内存映射工具

![image-20210322160807816](https://elgchat-oss.oss-accelerate.aliyuncs.com/elgchat/2021_03_22/image-20210322160807816.png)

## 垃圾回收（GC）策略

垃圾回收性能指标

* 吞吐量:工作时间(排除GC时间)占总时间的百分比， 工作时间并不仅是程序运行的时间，还包 含内存分配时间。
* 暂停时间:由垃圾回收导致的应用程序停止响应次数/时间。

### 垃圾回收器

* 串行收集器(Serial Collector)
  单线程执行所有的垃圾回收工作， 适用于单核CPU服务器 

  > 工作进程**-----|**(单线程)垃圾回收线程进行垃圾收集**|---**工作进程继续 

* 并行收集器(Parallel Collector)

  > 工作进程**-----|**(多线程)垃圾回收线程进行垃圾收集**|---**工作进程继续

  又称为吞吐量收集器(关注吞吐量)， 以并行的方式执行年轻代的垃圾回收， 该方式可以显著降 低垃圾回收的开销(指多条垃圾收集线程并行工作，但此时用户线程仍然处于等待状态)。适用于多处理器或多线程硬件上运行的数据量较大的应用

* 并发收集器(Concurrent Collector)

  以并发的方式执行大部分垃圾回收工作，以缩短垃圾回收的暂停时间。适用于那些响应时间优先于 吞吐量的应用， 因为该收集器虽然最小化了暂停时间(指用户线程与垃圾收集线程同时执行,但不一 定是并行的，可能会交替进行)， 但是会降低应用程序的性能

* CMS收集器(Concurrent Mark Sweep Collector)
   并发标记清除收集器， 适用于那些更愿意缩短垃圾回收暂停时间并且负担的起与垃圾回收共享处理器资源的应用

* G1收集器(Garbage-First Garbage Collector)

  适用于大容量内存的多核服务器， 可以在满足垃圾回收暂停时间目标的同时， 以最大可能性实现高吞吐量( JDK1.7之后)

### 垃圾回收器参数

| 参数                           | 描述                                                         |
| :----------------------------- | ------------------------------------------------------------ |
| -XX:+UseSerialGC               | 启用串行收集器                                               |
| -XX:+UseParallelGC             | 启用并行垃圾收集器，配置了该选项，那么 -XX:+UseParallelOldGC默认 启用 |
| -XX:+UseParNewGC               | 年轻代采用并行收集器，如果设置了 -XX:+UseConcMarkSweepGC选 项，自动启用 |
| --XX:ParallelGCThreads         | 年轻代及老年代垃圾回收使用的线程数。默认值依赖于JVM使用的CPU个数 |
| \- XX:+UseConcMarkSweepGC(CMS) | 对于老年代，启用CMS垃圾收集器。 当并行收集器无法满足应用的延迟需 求是，推荐使用CMS或G1收集器。启用该选项后， -XX:+UseParNewGC 自动启用。 |
| -XX:+UseG1GC                   | 启用G1收集器。 G1是服务器类型的收集器， 用于多核、大内存的机器。 它在保持高吞吐量的情况下，高概率满足GC暂停时间的目标。 |

