# 分布式理论:一致性协议 2PC 

> 2PC ( Two-Phase Commit缩写)即  两阶段提交协议，是将整个事务流程分为两个阶段，准备阶段(Prepare phase)、提交阶段(commit phase)，2是指两个阶段，P是指准备阶段，C是指提交阶段。   
在计算机中部分关系数据库如Oracle、MySQL支持两阶段提交协议. 
 ![](https://elgchat-oss.oss-accelerate.aliyuncs.com/elgchat/2021_03_22/page18image27294544.png) 

1. 准备阶段(Prepare phase):**事务管理器给每个参与者发送Prepare消息，每个数据库参与者在本地执行事 务，并写本地的Undo/Redo日志，此时事务没有提交**。 (Undo日志是记录修改前的数据，用于数据库回 滚，Redo日志是记录修改后的数据，用于提交事务后写入数 据文件) 

2. 提交阶段(commit phase):**如果事务管理器收到了参与者的执行失败或者超时消息时，直接给每个参与者 发送回滚(Rollback)消息;否则，发送提交(Commit)消息;参与者根据事务管理器的指令执行提交或者回滚操作，并释放事务处理过程中使用的锁资源**。注意:必须在最后阶段释放锁资源。 

## 2PC执行流程
**成功执行事务事务提交流程** 
![](https://elgchat-oss.oss-accelerate.aliyuncs.com/elgchat/2021_03_22/page19image27432848.png)   

* 阶段一:
	1. 事务询问：协调者向所有的参与者发送事务内容，询问是否可以执行事务提交操作，并开始等待各参与者的响应。 
	2. 执行事务 (写本地的Undo/Redo日志)
	3. 各参与者向协调者反馈事务询问的响应

* 阶段二：
	1. 发送提交请求: 
	协调者向所有参与者发出 commit 请求。 
	2. 事务提交: 
	参与者收到 commit 请求后，会正式执行事务提交操作，并在完成提交之后释放整个事务执行期间占用的事务资 源。 
	3. 反馈事务提交结果: 参与者在完成事务提交之后，向协调者发送 Ack 信息。 
	4. 完成事务:
	协调者接收到所有参与者反馈的 Ack 信息后，完成事务。 
- - - -
**中断事务步骤如下:** 
![](https://elgchat-oss.oss-accelerate.aliyuncs.com/elgchat/2021_03_22/page20image27423120.png) 
* 阶段一: 
	1. 事务询问 协调者向所有的参与者发送事务内容，询问是否可以执行事务提交操作，并开始等待各参与者的响应。 
	2. 执行事务 (写本地的Undo/Redo日志) 
	3. 各参与者向协调者反馈事务询问的响应 
	

 **总结: 各个参与者进行投票是否让事务进行.**

* 阶段二 
	1. 发送回滚请求:
	协调者向所有参与者发出 Rollback 请求。 
	2. 事务回滚:
	参与者接收到 Rollback 请求后，会利用其在阶段一中记录的 Undo 信息来执行事务回滚操作，并在完成回滚之后 
	释放在整个事务执行期间占用的资源。 
	3. 反馈事务回滚结果: 
	参与者在完成事务回滚之后，向协调者发送 Ack 信息。 
	4. 中断事务: 
	协调者接收到所有参与者反馈的 Ack 信息后，完成事务中断。 

**从上面的逻辑可以看出，二阶段提交就做了2个事情:投票，执行。**  

### Tips:什么是Ack？
> ACK 确认字符，在数据通信中，接收站发给发送站的一种传输类控制字符。表示发来的数据已确认接收无误。   

## 2PC优缺点
* 优点:原理简单，实现方便
* 缺点:同步阻塞，单点问题，数据不一致，过于保守
	1. **同步阻塞**:
	二阶段提交协议存在最明显也是最大的一个问题就是同步阻塞，在二阶段提交的执行过程中，所有参与该事务操作的逻辑都处于阻塞状态，也就是说，各个参与者在等待其他参与者响应的过程中，无法进行其他操作。这种同步阻塞极大的限制了分布式系统的性能。
	2. **单点问题** :
	协调者在整个二阶段提交过程中很重要，如果协调者在提交阶段出现问题，那么整个流程将无法运转，更重要的是:其他参与者将会处于一直锁定事务资源的状态中，而无法继续完成事务操作。
	3. **数据不一致**: 
	假设当协调者向所有的参与者发送 commit 请求之后，发生了局部网络异常或者是协调者在尚未发送完所有 commit 请求之前自身发生了崩溃，导致最终只有部分参与者收到了 commit 请求。这将导致严重的数据不一致问题。 
	4. **过于保守**: 
	如果在二阶段提交的提交询问阶段中，参与者出现故障而导致协调者始终无法获取到所有参与者的响应信息的话，这时协调者只能依靠其自身的超时机制来判断是否需要中断事务，显然，这种策略过于保守。换句话说，二阶段提交协议没有设计较为完善的容错机制，任意一个节点失败都会导致整个事务的失败。
