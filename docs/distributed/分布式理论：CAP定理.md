# 分布式理论：CAP定理
[[分布式架构概念、发展问题]]
[[分布式理论：一致性]]

> 2000 年7月的时候，加州大学伯克利分校的Eric Brewer 教授提出了 CAP 猜想，2年后，被 来自于麻省理工 的Seth Gilbert 和 Nancy Lynch 从理论上证明了猜想的可能性，从此，CAP 定理正式在学术上成为了分布式 计算领域的公认定理。并深深的影响了分布式计算的发展。   

CAP 理论含义是，一个分布式系统不可能同时满足**一致性(C:Consistency)::这里指最终一致性::**，**可用性(A: Availability)**和**分区容错性(P:Partition tolerance)**这三个基本需求，**最多只能同时满足其中的2个**。 

![](%E5%88%86%E5%B8%83%E5%BC%8F%E7%90%86%E8%AE%BA%EF%BC%9ACAP%E5%AE%9A%E7%90%86/721BF083-2561-4E85-8071-17539BBDE150.png)

![](%E5%88%86%E5%B8%83%E5%BC%8F%E7%90%86%E8%AE%BA%EF%BC%9ACAP%E5%AE%9A%E7%90%86/page13image27391600.png) 


> **C - Consistency**   
>   
> **一致性是值写操作后读操作可以读到最新的数据状态,当数据分布在多个节点上时,从任意节点读取到的数据都是最新的.**   
> 商品信息读写要满足一致性需要实现如下目标:   
> 1.商品服务写入主数据库成功, 则想从数据库查询数据也成功   
> 2.商品服务写入主数据库失败,则向从数据库查询也失败   

如何实现一致性? 
	1. 写入主数据库后要数据同步到从数据库 
	2. 写入主数据库后,在向从数据库同步期间要将从数据库锁定, 等待同步完成后在释放锁,以免在写新数据后,向从数据 库查询到旧的数据. 

分布式一致性的特点: 
	1. 由于存在数据库同步过程,写操作的响应会有一定的延迟 
	2. 为了保定数据的一致性,对资源暂时锁定,待数据同步完成后释放锁定资源 
	3. 如果请求数据同步失败的节点则会返回错误信息, 一定不会返回旧数据. 
- - - -
> **A - Availability**  
>   
> **可用性是指任何操作都可以得到响应的结果,且不会出现响应超时或响应错误。**   
> 商品信息读写要满足可用性需要实现如下目标:   
> 	1.从数据库接收到数据库查询的请求则立即能够响应数据查询结果   
> 	2.从数据库不允许出现响应超时或错误  

如何实现可用性? 
	1. 写入主数据库后要将数据同步到从数据 
	2. 由于要保证数据库的可用性,不可以将数据库中资源锁定 
	3. 即使数据还没有同步过来,从数据库也要返回查询数据, 哪怕是旧数据,但不能返回错误和超时.  
- - - -
> **P - Partition tolerance**  
>   
> **分布式系统的各个节点部署在不同的子网中, 不可避免的会出现由于网络问题导致节点之间通信失败,此时仍可以对外提供服务, 这个就是分区容错性 (分区容忍性).**   
> 商品信息读写要满足分区容错性需要实现如下目标:   
> 1.主数据库想从数据库同步数据失败不形象写操作   
> 2.其中一个节点挂掉不会影响另一个节点对外提供服务  
 
如何实现分区容错性? 
	1. 尽量使用异步取代同步操作,举例 使用异步方式将数据从主数据库同步到从数据库, 这样节点之间能有效的实现松耦合; 
	2. 添加数据库节点,其中一个从节点挂掉,由其他从节点提供服务 

## CAP只能3选2 
 
![](%E5%88%86%E5%B8%83%E5%BC%8F%E7%90%86%E8%AE%BA%EF%BC%9ACAP%E5%AE%9A%E7%90%86/BB4E0F9C-65E4-4EAA-95C2-862534466DF7.png)

试着证明一下为什么CAP不能同时满足?

![](%E5%88%86%E5%B8%83%E5%BC%8F%E7%90%86%E8%AE%BA%EF%BC%9ACAP%E5%AE%9A%E7%90%86/page15image27663264.png) 

> 有用户向N1发送了请求更改了数据，将数据库从V0更新成了V1。由于网络断开，所以N2数据库依然是V0，如果这个时候 有一个请求发给了N2，但是N2并没有办法可以直接给出最新的结果V1，这个时候该怎么办呢?   
>   
> 这个时候无法两种方法，一种是将错就错，将错误的V0数据返回给用户。第二种是阻塞等待，等待网络通信恢复，N2中 的数据更新之后再返回给用户。显然前者牺牲了一致性，后者牺牲了可用性。   
>   
> 这个例子虽然简单，但是说明的内容却很重要。在分布式系统当中，CAP三个特性我们是无法同时满足的，必然要舍弃一 个。三者舍弃一个，显然排列组合一共有三种可能。   

1. **舍弃A(可用性)，保留CP(一致性和分区容错性)** 
> 一个系统保证了一致性和分区容错性，舍弃可用性。也就是说在极端情况下，允许出现系统无法访问的情况出现，这个时候往往会牺牲用户体验，让用户保持等待，一直到系统数据一致了之后，再恢复服务。  

2. **舍弃C(一致性)，保留AP(可用性和分区容错性)** 
> 这种是大部分的分布式系统的设计，保证高可用和分区容错，但是会牺牲一致性。   

3.  **舍弃P(分区容错性)，保留CA(一致性和可用性)** 
> 如果要舍弃P，那么就是要舍弃分布式系统，CAP也就无从谈起了。可以说P是分布式系统的前提，所以这种情况是不存在的。   





#code/分布式