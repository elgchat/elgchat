# 分布式理论:一致性协议 3PC 

> 3PC，全称 “three phase commit”，是 2PC 的改进版，将 2PC 的 “提交事务请求” 过程一分为二，共形成了由 CanCommit、PreCommit和doCommit三个阶段组成的事务处理协议。   

![](https://elgchat-oss.oss-accelerate.aliyuncs.com/elgchat/2021_03_22/page22image27379744.png) 
## 三阶段提交流程 
### canCommit
	1. 事务询问
	协调者向所有的参与者发送一个包含事务内容的canCommit请求，询问是否可以执行事务提交操作，并开始等待 各参与者的响应。 
	2. 各参与者向协调者反馈事务询问的响应 
	参与者在接收到来自协调者的包含了事务内容的canCommit请求后，正常情况下，如果自身认为可以顺利执行事 务，则反馈Yes响应，并进入预备状态，否则反馈No响应。 	 

### preCommit
**协调者在得到所有参与者的响应之后，会根据结果有2种执行操作的情况:执行事务预提交，或者中断事务** 
假如所有参与反馈的都是Yes，那么就会执行事务预提交 

**预提交事务流程**
	1. 发送预提交请求: 
	协调者向所有参与者节点发出preCommit请求，并进入prepared阶段。 
	2. 事务预提交: 
	参与者接收到preCommit请求后，会执行事务操作，并将Undo和Redo信息记录到事务日志中。 
	3. 各参与者向协调者反馈事务执行的结果: 
	若参与者成功执行了事务操作，那么反馈Ack 

**若任一参与者反馈了No响应，或者在等待超时后，协调者尚无法接收到所有参与者反馈，则中断事务** 

**中断事务流程:** 
	1. 发送中断请求: 
	协调者向所有参与者发出abort请求。 
	3. 中断事务: 
	无论是收到来自协调者的abort请求或者等待协调者请求过程中超时，参与者都会中断事务 

### doCommit
该阶段做真正的事务提交或者完成事务回滚，所以就会出现两种情况: 

**执行事务提交流程**
	1. 发送提交请求: 
	进入这一阶段，假设协调者处于正常工作状态，并且它接收到了来自所有参与者的Ack响应，那么他将从预提交状态转化为提交状态，并向所有的参与者发送doCommit请求。 
	2. 事务提交: 
	参与者接收到doCommit请求后，会正式执行事务提交操作，并在完成提交之后释放整个事务执行过程中占用的事 务资源。 
	3. 反馈事务提交结果: 
	参与者在完成事务提交后，向协调者发送Ack响应。 
	4. 完成事务: 
	协调者接收到所有参与者反馈的Ack消息后，完成事务。 

**中断事务流程** 
	1. 发送中断请求:
	协调者向所有的参与者节点发送abort请求。 
	2. 事务回滚:
	参与者收到abort请求后，会根据记录的Undo信息来执行事务回滚，并在完成回滚之后释放整 个事务执行期间占用的资源。 
	3. 反馈事务回滚结果 
	参与者在完成事务回滚后，向协调者发送Ack消息。 
	4. 中断事务 
	协调者接收到所有参与者反馈的Ack消息后，中断事务。 

**注意：一旦进入阶段三，可能会出现 2 种故障:** 
	1. **协调者出现问题**
	2. **协调者和参与者之间的网络故障** 
	
**如果出现了任一一种情况，最终都会导致参与者无法收到 doCommit 请求或者 abort 请求，针对这种情况，参与者都会在等待超时之后，继续进行事务提交** 


## 2PC对比3PC 
1. 首先对于协调者和参与者都设置了超时机制(在2PC中，只有协调者拥有超时机制，即如果在一定时间内没有收 到参与者的消息则默认失败),主要是避免了参与者在长时间无法与协调者节点通讯(协调者挂掉了)的情况下，无 法释放资源的问题，因为参与者自身拥有超时机制会在超时后，自动进行本地commit从而进行释放资源。而这种机制也侧面降低了整个事务的阻塞时间和范围。 
2. 通过**CanCommit、PreCommit、DoCommit**三个阶段的设计，相较于2PC而言，多设置了一个缓冲阶段保证了在最后提交阶段之前各参与节点的状态是一致的 。 
3. PreCommit是一个缓冲，保证了在最后提交阶段之前各参与节点的状态是一致的。 

**问题:3PC协议并没有完全解决数据不一致问题。** 