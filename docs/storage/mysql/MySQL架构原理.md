MYSQL 是最流行的关系型数据库软件之一，由于其体积小、速度快、开源免费、简单易用、维护成本
低等，在集群架构中易于扩展、高可用，因此深受开发者和企业的欢迎。

## MYSQL 体系架构

<img src="https://elgchat-oss.oss-accelerate.aliyuncs.com/elgchat/2021_05_12/image-20210512155544830.png" alt="image-20210512155544830" style="zoom:33%;" />

MYSQL Server架构自顶向下大致可以分网络连接层、服务层、存储引擎层和系统文件层。

### 网络连接层

* 客户端连接器(Client Connectors)：提供与MYSQL服务器建立的支持。目前几乎支持所有主流的服务端编程技术，例如常见的 Java、C、Python、.NET等，它们通过各自API技术与MYSQL建立连接。

### 服务层

服务层是MYSQL Server的核心，主要包含系统管理和控制工具、连接池、SQL接口、解析器、查询优化器和缓存六个部分。

* 连接池：负责存储和管理客户端与数据库的连接，一个线程负责管理一个连接
* 系统管理和控制工具：备份回复、安全管理、集群管理等
* SQL接口：用于接受客户端发送的各种sql命令，并且返回用户需要查询的结果，比如DDL、DML、存储过程、视图、触发器等。
* 解析器：负责将请求的SQL解析生成一个"解析树"，然后根据一些MYSQL规则进一步检查解析树是否合法
* 查询优化器：当"解析树"通过解析器语法检查后，将由优化器将其转化为执行计划，然后与存储引擎交互

>Select id form t_user where gender = 1;
>
>选取 -> 投影 -> 联接 策略
>
>1. Select先根据where语句进行选取，并不是查询出全部数据再过滤
>2. select查询根据id进行属性投影，并不是取出所有字段
>3. 将前面选取和投影连接起来最终生成查询结果

* 缓存：缓存机制是由一系列小缓存组成的，比如表缓存、记录缓存、权限缓存、引擎缓存等。如果查询缓存命中的查询结果，查询语句就可以去查询缓存中取数据

### 存储引擎层

存储引擎负责MYSQL中数据的存储与读取，与底层系统文件进行交互，MYSQL存储引擎是插件式的，服务器中节骨的查询执行引擎通过接口与存储引擎进行通讯，接口屏蔽了不同存储引擎之间的差异，现在有很多存储引擎，各有个的特点，最常见的是MyISAM和InnoDB引擎

### 系统文件

该层负责将数据库的数据和日志存储在文件系统之上，并完成与存储引擎的交互，是文件的物理存储层，主要包含日志文件，数据文件，配置文件，pid文件，socket文件等

* 日志文件

  * 错误日志（error log）

    ```sql
    # 默认开启
    show variables like '%log_error%'
    ```

  * 通用查询日志（General query log）

    ```sql
    # 记录一般查询语句
    show variables like '%general%'
    ```

  * 二进制日志（binary log）

    记录了对MYSQL数据库执行的更改操作，并且记录了语句的发生时间、执行时常；但他不记录select、show等不修改数据的sql，主要用于数据库的恢复和主从复制

    ```sql
    # 是否开启
    show variables like '%log_bin%';
    
    # 参数查看
    show variables like '%binlog%';
    
    # 查看日志文件
    show binary logs;
    ```

  * 慢查询日志（slow query log）

    记录所有执行时间超市的查询sql，默认是10秒

    ```sql
    # 是否开启
    show variables like '%slow_query%'
    
    #时长
    show variables like '%long_query_time%'
    ```

* 配置文件

  用于存放MYSQL所有的配置信息文件，比如my.cnf，my.ini等

* 数据文件

  * db.opt文件：记录这个库的默认使用的字符集和校验规则
  * frm文件：存储与表相关的元数据（meta）信息，包括表结构的定义信息等，每一张表都会有一个frm文件
  * MYD文件：MyISAM存储引擎专用，存放MyISAM表的数据（data），每一张表都会有一个MYD文件
  * MYI文件：MyISAM存储引擎专用，存放MyISAM表的索引信息，每一张MyISAM表对应一个MYI文件
  * ibd文件和IBDATA文件：存放InnoDB的数据文件（包含索引），InnoDB存储引擎有两种表空间方式：独享表空间和共享表空间，独享表空间使用.ibd文件存放时间，且每一张InnoDB表对应一个.ibd文件，共享表使用.ibdata文件，所有的表共同使用一个（或多个，自行配置）.ibdata文件
  * ibdata1文件：系统表空间数据文件，存储表元数据、Undo日志等
  * ib_logfile0、ib_logfile1文件：Redo log日志文件

* pid文件

  pid文件是MYSQLd应用程序在unix/linux环境下的一个进程文件，和许多其他unix/linux服务端程序一样，它存放着自己进程id

* socket文件

  socket文件也是在unix/linux环境下拥有的，用户在unix/linux环境下客户端连接可以不通过tcp/ip网络而之间使用unix socket来连接MYSQL

## MYSQL运行机制

<img src="https://elgchat-oss.oss-accelerate.aliyuncs.com/elgchat/2021_05_13/image-20210513000830518.png" alt="image-20210513000830518" style="zoom:50%;" />

1. 建立连接，通过客户端/服务器通信协议与MYSQL建立连接，MYSQL客户端与服务端的通信方式是"半双工"，对于每一个MYSQL的连接，时刻都有一个线程状态来表示这个连接在做什么

   通讯机制：

   * 全双工：能同时发送和接受数据
   * 半双工：指的某一时刻，要么发送数据，要么接收数据，不能同时
   * 单工：只能发送数据或只能接收数据

   线程信息：

   ```sql
   # 查看用户正在运行的线程信息，root用户能查看所有的线程，其他用户只能看自己的
   show processlist;
   ```

   * id：线程id，可以使用kill xxx

   * user：启动这个线程的用户

   * Host：发送请求的客户端的ip和端口号

   * db：当前的命令在哪个库执行

   * Command：该线程长在执行的操作命令

     * create DB：正在创建库操作
     * Drop DB：正在删除库操作
     * Execute：正在执行一个PreparedStatement
     * Close Stmt：正在关闭一个PreparedStatement
     * Query：正在执行一个语句
     * Sleep：正在等待客户端发送语句
     * Quit：正在退出
     * ShutDown：正在关闭服务器

   * Time：表示该线程处于当前状态的时间，单位是秒

   * State：线程状态

     * Updating：正在搜索匹配条件，进行修改
     * Sleeping：长在等待客户端发送新请求
     * Starting：正在执行请求处理
     * Checking table：正在检查数据表
     * Closing table：正在将表中数据刷新到磁盘中
     * Locked：被其他查询锁住了记录
     * Sending data：正在处理select查询，同时将结果发送给客户端

   * info：一般记录线程执行的语句，默认显示前100个字符

     ```sql
     #查询完整的线程执行语句
     show full processlist;
     ```

2. 查询缓存，这是MYSQL的一个可优化查询的机房，如果开启了查询缓存并且在查询缓存过程中查询到完全相同的sql语句，则将查询结果直接返回给客户端；如果没有开启查询或者没有查询到完全相同的sql语句则会有解析器进行语法语义解析，并生成"解析树"

   * 缓存select查询的结果和sql语句

   * 执行select查询时，先查询缓存，判断是否存在可用的记录集，要求是否完全相同（包含参数值），这样才会匹配缓存数据命中

   * 及时开启查询缓存，一下sql也不能缓存

     * 查询语句使用SQL_NO_CACHE
     * 查询结果大于query_cache_limit设置
     * 查询中有一些不确定的参数，比如now()

	```sql
	#查看查询缓存是否启用，空间大小，限制等
	show variables like '%query_cache%';
	
	#查看更详细的缓存参数，可用缓存空间，缓存块，缓存多少等
	show variables like 'Qcache';
	```

3. 解析器将客户端发送的sql进行语法解析，生成"解析树"，预处理器根据一些MYSQL规则进一步检查"解析树"是否合法，例如这里将检查数据表和数据列是否存在，还会解析名字和别名，看看他们是否有歧义，最后生成新的"解析树"
4. 查询优化器根据"解析树"生成最优的执行计划，MYSQL使用很多优化策略生成最优的执行计划，可以分为两类：静态优化（编译时优化）、动态优化（运行时优化）
   * 等价变换策略
     * 1=1 and a>1 改为a>1
     * a<b and a=5 改为 b>5 and a=5
     * 基于联合索引，调整条件位置等
   * 优化count、min、max等函数
     * InnoDB引擎min函数只需要找函数最左边
     * InnoDB引擎max函数只需要找索引最右面
     * MyISAM引擎count(*)，不需要计算，直接返回
   * 提前终止查询
     * 使用了limit查询，获取limit所需的数据，就不在继续遍历后面的数据
   * in的优化
     * MYSQL对in查询，会先进行排序，在采用二分查找法查找数据，比如 where id in(3,1,2) 会改为 in (1,2,3)
5. 查询执行引擎负责执行SQL语句，此时查询执行引擎会根据sql语句中标得存储引擎类型，以及对应的api接口与底层存储引擎缓存或者物理文件的交互，得到查询结果并返回给客户端，若开启查询缓存，这是会将sql语句和结果完整的保存到查询缓存中，以后若有相同的sql语句执行则直接返回结果
   * 如果开启了查询缓存，先将查询结果做缓存操作
   * 返回结果过多，采用增量模式返回

## MYSQL存储引擎

存储引擎在MYSQL中负责数据的存储和提起，是与文件打交道的子系统，它是根据MYSQL提供的文件访问层抽象接口定制的一种文件访问机制，这种机制就叫做存储引擎

```sql
# 查看当前数据库版本支持的引擎信息
show engines;
```

![image-20210513012153994](https://elgchat-oss.oss-accelerate.aliyuncs.com/elgchat/2021_05_13/image-20210513012153994.png)

在5.5版本之前默认采用MyISAM存储引擎，从5.5开始采用InnoDB存储引擎。

* InnoDB:支持事务，具有提交，回滚和崩溃恢复能力，事务安全 
* MyISAM:不支持事务和外键，访问速度快 
* Memory:利用内存创建表，访问速度非常快，因为数据在内存，而且默认使用Hash索引，但是 一旦关闭，数据就会丢失
* Archive:归档类型引擎，仅能支持insert和select语句 
* Csv:以CSV文件进行数据存储，由于文件限制，所有列必须强制指定not null，另外CSV引擎也不 支持索引和分区，适合做数据交换的中间表
* BlackHole: 黑洞，只进不出，进来消失，所有插入数据都不会保存 
* Federated:可以访问远端MySQL数据库中的表。一个本地表，不保存数据，访问远程表内容。
* MRG_MyISAM:一组MyISAM表的组合，这些MyISAM表必须结构相同，Merge表本身没有数据， 对Merge操作可以对一组MyISAM表进行操作。

### InnoDB与MyISAM对比

|            | InnoDB                                                       | MyISAM                                                       |
| :--------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 事务和外键 | 支持事务和外键，具有安全性和完整性，适合大量insert或update操作 | 不支持事务和外键，它提供了高速存储和检索，适合大量的select查询操作 |
| 锁机制     | 支持行级锁，锁定制定记录，基于索引加锁实现                   | 支持表级锁，锁定整张表                                       |
| 索引结构   | 使用聚集索引(聚簇索引)，索引和记录在一起存储，既缓存索引，也缓存记录。 | 使用非聚集索引(非聚簇索引)，索引和记录分开。                 |
| 并发处理   | 与隔离级别有关，可以采用多版本并发控制（MVCC）来支持高并发   | 使用表锁，会导致写操作并发率低，读之间并不阻塞，读写阻塞     |
| 存储文件   | .frm表结构文件、.Ibd数据文件，单表最大支持64TB               | .frm表结构文件、MYD数据文件、MYI索引文件，从MYSQL5.0开始默认是256TB |
| 适用场景   | 1.需要事务支持<br />2. 行级锁对高并发有很好的适应能力<br />3.数据更新比较频繁<br />4.数据一致性较高<br />5.硬件设备内存大，可以利用缓存机制来提高内存利用率，减少磁盘IO | 1. 不支持事务<br />2.并发相对较低（锁定机制问题）<br />3.数据修改相对较低，以读为主<br />4.数据一致性要求不高 |

